{% extends 'base.html' %}

{% block title %}–ü—Ä–æ—Ñ–∏–ª—å - –í–û–Ω–ª–∞–π–Ω–µ{% endblock %}

{% block content %}
    <section class="profile">
        <div class="profile-header">
            <div class="avatar-container">
                <form id="avatarForm" enctype="multipart/form-data">
                    <div class="avatar-wrapper">
                        <label for="avatarInput">
                            <img id="avatarImage" src="{{ user.avatar_url or url_for('static', filename='img/default_avatar.png') }}" alt="–ê–≤–∞—Ç–∞—Ä" class="profile-avatar">
                            <span class="avatar-text">–ò–∑–º–µ–Ω–∏—Ç—å</span>
                        </label>
                        <button id="deleteAvatar" class="delete-avatar-btn">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                    <input type="file" id="avatarInput" name="avatar" accept="image/*" style="display: none;">
                </form>
            </div>
        
            <div class="profile-main">
                <h2 id="profile-username">{{ user.username }}</h2>
                <span id="toggleInfo" class="info-toggle">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</span>
            </div>
        </div>                    
    </section>

    <section class="friends-block">
        <h3>–î—Ä—É–∑—å—è <a href="/friends" class="show-all-friends">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö</a></h3>
        <div id="friends-list" class="friends-grid">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
    </section>

    <section class="new-post">
        <h3>–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?</h3>
        <textarea id="postContent" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å..."></textarea>
        <button id="postButton" class="btn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </section>

    <section class="feed">
        <h3>–ü—É–±–ª–∏–∫–∞—Ü–∏–∏</h3>
        {% for post in posts %}
            <div class="post" id="post-{{ post.id }}">
                <div class="post-header">
                    <img src="{{ post.user.avatar_url }}" class="post-avatar">
                    <strong>{{ post.user.username }}</strong>
                    <span class="post-time">{{ post.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                    <button class="delete-post" data-id="{{ post.id }}">üóë –£–¥–∞–ª–∏—Ç—å</button>
                </div>
                <p>{{ post.content }}</p>
    
                <div class="post-actions">
                    <button class="like-post" data-id="{{ post.id }}">‚ù§Ô∏è {{ post.likes }}</button>
                    <button class="comment-toggle" data-id="{{ post.id }}">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</button>
                </div>
    
                <div class="comment-section hidden" id="comment-section-{{ post.id }}">
                    <div class="comments-list">
                        {% for comment in post.comments %}
                            <div class="comment" id="comment-{{ comment.id }}">
                                <img src="{{ comment.user.avatar_url }}" class="comment-avatar">
                                <div class="comment-content">
                                    <strong>{{ comment.user.username }}</strong>
                                    <span class="comment-time">{{ comment.timestamp.strftime('%H:%M %d.%m.%Y') }}</span>
                                    <p class="comment-text">{{ comment.content }}</p>
                                </div>
                                {% if comment.user_id == user.id %}
                                    <button class="delete-comment" data-id="{{ comment.id }}">üóë</button>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                    <div class="comment-input-section">
                        <input type="text" class="comment-input" data-id="{{ post.id }}" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">
                        <button class="comment-btn" data-id="{{ post.id }}">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        {% endfor %}
    </section>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div id="infoModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>–õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <p><strong>Email:</strong> <span id="emailText">{{ user.email }}</span> 
                <a href="#" class="edit-info" data-field="email">(–ò–∑–º–µ–Ω–∏—Ç—å)</a>
            </p>
            <input type="email" id="editEmail" class="hidden" value="{{ user.email }}">
    
            <p><strong>–û —Å–µ–±–µ:</strong> <span id="bioText">{{ user.bio or '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</span> 
                <a href="#" class="edit-info" data-field="bio">(–ò–∑–º–µ–Ω–∏—Ç—å)</a>
            </p>
            <textarea id="editBio" class="hidden">{{ user.bio or '' }}</textarea>
    
            <button id="saveInfo" class="btn hidden">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
    

    <script>
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥—Ä—É–∑–µ–π
        document.addEventListener("DOMContentLoaded", function () {
            const friendsList = document.getElementById("friends-list");

            function loadFriends() {
                fetch(`/api/get_friends/{{ user.id }}`)
                    .then(response => response.json())
                    .then(friends => {
                        friendsList.innerHTML = "";
                        if (friends.length === 0) {
                            friendsList.innerHTML = "<p>–ù–µ—Ç –¥—Ä—É–∑–µ–π</p>";
                        } else {
                            friends.slice(0, 6).forEach(friend => {
                                let div = document.createElement("div");
                                div.classList.add("friend-card");

                                let avatar = document.createElement("img");
                                avatar.src = friend.avatar_url || "/static/img/default_avatar.png";
                                avatar.classList.add("friend-avatar");

                                let name = document.createElement("a");
                                name.href = `/profile/${friend.id}`;
                                name.textContent = friend.name;
                                name.classList.add("friend-name");

                                div.appendChild(avatar);
                                div.appendChild(name);
                                friendsList.appendChild(div);
                            });
                        }
                    });
            }

            loadFriends();
        });
        
        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        document.querySelectorAll(".edit-info").forEach(link => {
                link.addEventListener("click", function(event) {
                    event.preventDefault();
                    const field = this.getAttribute("data-field");
                    if (field === "email") {
                        document.getElementById("emailText").classList.add("hidden");
                        document.getElementById("editEmail").classList.remove("hidden");
                    } else if (field === "bio") {
                        document.getElementById("bioText").classList.add("hidden");
                        document.getElementById("editBio").classList.remove("hidden");
                    }
                    document.getElementById("saveInfo").classList.remove("hidden");
                });
            });
        
            document.addEventListener("DOMContentLoaded", function () {
                const deleteAvatarBtn = document.getElementById("deleteAvatar");
                const avatarImage = document.getElementById("avatarImage");

                if (deleteAvatarBtn) {
                    deleteAvatarBtn.addEventListener("click", function (event) {
                        event.preventDefault(); // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏

                        fetch("/api/delete_avatar", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                avatarImage.src = "/static/img/default_avatar.png"; // –ú–µ–Ω—è–µ–º –Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –∞–≤–∞—Ç–∞—Ä–∫—É
                                deleteAvatarBtn.style.display = "none"; // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                            } else {
                                alert("–û—à–∏–±–∫–∞: " + (data.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
                            }
                        })
                        .catch(error => {
                            console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", error);
                            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞–≤–∞—Ç–∞—Ä–∞.");
                        });
                    });
                }
            });

            document.addEventListener("DOMContentLoaded", function () {
                const toggleInfo = document.getElementById("toggleInfo");
                const infoContainer = document.getElementById("infoContainer");
                
                toggleInfo.addEventListener("click", function () {
                    infoContainer.classList.toggle("active"); // –û—Ç–∫—Ä—ã–≤–∞–µ–º/–∑–∞–∫—Ä—ã–≤–∞–µ–º –ª–∏—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                });

                const editButtons = document.querySelectorAll(".edit-info");
                const saveButton = document.getElementById("saveInfo");

                editButtons.forEach(button => {
                    button.addEventListener("click", function (event) {
                        event.preventDefault();
                        let field = this.getAttribute("data-field");
                        let textSpan = document.getElementById(field + "Text");
                        let inputField = document.getElementById("edit" + field.charAt(0).toUpperCase() + field.slice(1));

                        textSpan.classList.add("hidden");
                        inputField.classList.remove("hidden");
                        saveButton.classList.remove("hidden");
                    });
                });

                saveButton.addEventListener("click", function () {
                    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    saveButton.classList.add("hidden");
                });
            });

            document.addEventListener("DOMContentLoaded", function () {
                const modal = document.getElementById("infoModal");
                const btn = document.getElementById("toggleInfo");
                const closeBtn = document.querySelector(".modal .close");

                // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
                modal.style.display = "none";

                // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (–ø—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∫–Ω–æ–ø–∫–∞)
                if (btn) {
                    btn.addEventListener("click", function () {
                        modal.style.display = "flex";
                    });
                }

                // –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∫—Ä–µ—Å—Ç–∏–∫ (–ø—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∫–Ω–æ–ø–∫–∞)
                if (closeBtn) {
                    closeBtn.addEventListener("click", function () {
                        modal.style.display = "none";
                    });
                }

                // –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                window.addEventListener("click", function (event) {
                    if (event.target === modal) {
                        modal.style.display = "none";
                    }
                });
            });


        document.addEventListener("DOMContentLoaded", function() {
            // –û—Ç–∫—Ä—ã—Ç–∏–µ/—Å–∫—Ä—ã—Ç–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
            document.querySelectorAll(".comment-toggle").forEach(button => {
                button.addEventListener("click", function() {
                    const postId = this.getAttribute("data-id");
                    const commentSection = document.getElementById(`comment-section-${postId}`);
                    commentSection.classList.toggle("hidden");
                });
            });
            function validateEmail(email) {
                const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailPattern.test(email);
            }

            document.getElementById("toggleInfo").addEventListener("click", function() {
                document.getElementById("infoContainer").classList.toggle("hidden");
            });

            document.getElementById("saveInfo").addEventListener("click", function () {
                const email = document.getElementById("editEmail").value.trim();
                const bio = document.getElementById("editBio").value.trim();

                if (!validateEmail(email)) {
                    alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email!");
                    return;
                }

                fetch("/api/update_profile", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, bio })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        location.reload();
                    } else {
                        alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + (data.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
                    }
                });
            });

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
            document.querySelectorAll(".comment-btn").forEach(button => {
                button.addEventListener("click", function() {
                    const postId = this.getAttribute("data-id");
                    const commentInput = document.querySelector(`.comment-input[data-id='${postId}']`);
                    const commentText = commentInput.value.trim();

                    if (!commentText) {
                        alert("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!");
                        return;
                    }

                    fetch(`/api/comment_post/${postId}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ content: commentText })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            location.reload();
                        } else {
                            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: " + (data.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
                        }
                    });
                });
            });

            // –õ–∞–π–∫ –ø–æ—Å—Ç–∞
            document.querySelectorAll(".like-post").forEach(button => {
                button.addEventListener("click", function() {
                    const postId = this.getAttribute("data-id");

                    fetch(`/api/like_post/${postId}`, { method: "POST" })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            this.textContent = `‚ù§Ô∏è ${data.likes}`;
                        } else {
                            alert("–û—à–∏–±–∫–∞: " + (data.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
                        }
                    });
                });
            });

            // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞
            document.querySelectorAll(".delete-post").forEach(button => {
                button.addEventListener("click", function() {
                    if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?")) return;

                    fetch(`/api/delete_post/${this.dataset.id}`, { method: "DELETE" })
                    .then(() => location.reload());
                });
            });
            
            // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞
            document.getElementById("postButton").addEventListener("click", function() {
                const content = document.getElementById("postContent").value.trim();
                if (!content) {
                    alert("–ü–æ—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!");
                    return;
                }

                fetch("/api/create_post", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ content })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        location.reload();
                    } else {
                        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Å—Ç–∞: " + (data.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
                    }
                });
            });

            // –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
            document.querySelectorAll(".delete-comment").forEach(button => {
                button.addEventListener("click", function() {
                    const commentId = this.getAttribute("data-id");

                    fetch(`/api/delete_comment/${commentId}`, { method: "DELETE" })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            document.getElementById(`comment-${commentId}`).remove();
                        } else {
                            alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: " + (data.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
                        }
                    });
                });
            });
        });
    </script>
{% endblock %}
