{% extends 'base.html' %}

{% block title %}–õ–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π - –í–û–Ω–ª–∞–π–Ω–µ{% endblock %}

{% block content %}
<section class="new-post">
    <h3>–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?</h3>
    <textarea id="postContent" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å..."></textarea>
    <button id="postButton" class="btn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
</section>

<section class="feed">
    <h3>–ù–æ–≤–æ—Å—Ç–∏</h3>
    {% for post in posts %}
        <div class="post" id="post-{{ post.id }}">
            <div class="post-header">
                <img src="{{ post.user.avatar_url }}" class="post-avatar">
                <strong>{{ post.user.username }}</strong>
                <span class="post-time">{{ post.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                <button class="delete-post" data-id="{{ post.id }}">üóë –£–¥–∞–ª–∏—Ç—å</button>
            </div>
            <p>{{ post.content }}</p>

            <div class="post-actions">
                <button class="like-post" data-id="{{ post.id }}">‚ù§Ô∏è {{ post.likes }}</button>
                <button class="comment-toggle" data-id="{{ post.id }}">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</button>
            </div>

            <div class="comment-section hidden" id="comment-section-{{ post.id }}">
                <div class="comments-list">
                    {% for comment in post.comments %}
                        <div class="comment" id="comment-{{ comment.id }}">
                            <img src="{{ comment.user.avatar_url }}" class="comment-avatar">
                            <div class="comment-content">
                                <strong>{{ comment.user.username }}</strong>
                                <span class="comment-time">{{ comment.timestamp.strftime('%H:%M %d.%m.%Y') }}</span>
                                <p class="comment-text">{{ comment.content }}</p>
                            </div>
                            {% if comment.user_id == user.id %}
                                <button class="delete-comment" data-id="{{ comment.id }}">üóë</button>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                <div class="comment-input-section">
                    <input type="text" class="comment-input" data-id="{{ post.id }}" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">
                    <button class="comment-btn" data-id="{{ post.id }}">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    {% endfor %}
</section>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // –û—Ç–∫—Ä—ã—Ç–∏–µ/—Å–∫—Ä—ã—Ç–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
        document.querySelectorAll(".comment-toggle").forEach(button => {
            button.addEventListener("click", function() {
                const postId = this.getAttribute("data-id");
                const commentSection = document.getElementById(`comment-section-${postId}`);
                commentSection.classList.toggle("hidden");
            });
        });
        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
        document.querySelectorAll(".comment-btn").forEach(button => {
            button.addEventListener("click", function() {
                const postId = this.getAttribute("data-id");
                const commentInput = document.querySelector(`.comment-input[data-id='${postId}']`);
                const commentText = commentInput.value.trim();

                if (!commentText) {
                    alert("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!");
                    return;
                }

                fetch(`/api/comment_post/${postId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ content: commentText })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        location.reload();  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ—Å–ª–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
                    } else {
                        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: " + (data.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
                    }
                });
            });
        });

        // –õ–∞–π–∫ –ø–æ—Å—Ç–∞
        document.querySelectorAll(".like-post").forEach(button => {
            button.addEventListener("click", function() {
                const postId = this.getAttribute("data-id");

                fetch(`/api/like_post/${postId}`, { method: "POST" })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        this.textContent = `‚ù§Ô∏è ${data.likes}`;
                    } else {
                        alert("–û—à–∏–±–∫–∞: " + (data.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
                    }
                });
            });
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞
        document.querySelectorAll(".delete-post").forEach(button => {
            button.addEventListener("click", function() {
                if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?")) return;

                fetch(`/api/delete_post/${this.dataset.id}`, { method: "DELETE" })
                .then(() => location.reload());
            });
        });

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞
        document.getElementById("postButton").addEventListener("click", function() {
            const content = document.getElementById("postContent").value.trim();
            if (!content) {
                alert("–ü–æ—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!");
                return;
            }

            fetch("/api/create_post", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ content })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    location.reload();
                } else {
                    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Å—Ç–∞: " + (data.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
                }
            });
        });
        // –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
        document.querySelectorAll(".delete-comment").forEach(button => {
            button.addEventListener("click", function() {
                const commentId = this.getAttribute("data-id");

                fetch(`/api/delete_comment/${commentId}`, { method: "DELETE" })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        document.getElementById(`comment-${commentId}`).remove();
                    } else {
                        alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: " + (data.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
                    }
                });
            });
        });
    });
</script>
{% endblock %}
